\hypertarget{_weak_8h_source}{}\doxysection{Weak.\+h}
\label{_weak_8h_source}\index{src/rend/sys/Weak.h@{src/rend/sys/Weak.h}}
\mbox{\hyperlink{_weak_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_zero_8h}{Zero.h}}"{}}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_exception_8h}{Exception.h}}"{}}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_lock_8h}{Lock.h}}"{}}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{config_8h}{config.h}}"{}}}
\DoxyCodeLine{5 }
\DoxyCodeLine{6 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacesys}{sys}}}
\DoxyCodeLine{7 \{}
\DoxyCodeLine{8 }
\DoxyCodeLine{9 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{10 \textcolor{keyword}{struct }Weak;}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{13 \textcolor{keyword}{struct }Ptr;}
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{keyword}{struct }Rc}
\DoxyCodeLine{16 \{}
\DoxyCodeLine{17   \mbox{\hyperlink{structsys_1_1_zero}{Zero<int>}} \mbox{\hyperlink{structsys_1_1_rc_a25830873e507c913bff020af51d18621}{strong}};}
\DoxyCodeLine{18   \mbox{\hyperlink{structsys_1_1_zero}{Zero<int>}} \mbox{\hyperlink{structsys_1_1_rc_ab77044e0cdd7fe3dd8e60b884df5429c}{weak}};}
\DoxyCodeLine{19   \mbox{\hyperlink{structsys_1_1_lock_block}{LockBlock}} \mbox{\hyperlink{structsys_1_1_rc_a5ba31d2f4247ed423d9c8a71bfbc88d9}{lock}};}
\DoxyCodeLine{20 \};}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{keyword}{struct }\mbox{\hyperlink{structsys_1_1_enable_weak}{EnableWeak}}}
\DoxyCodeLine{23 \{}
\DoxyCodeLine{24   \mbox{\hyperlink{structsys_1_1_enable_weak_ad800200238a91dbf2690d2392f3c5a18}{EnableWeak}}() :}
\DoxyCodeLine{25     \mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}}(new \mbox{\hyperlink{structsys_1_1_rc}{Rc}}())}
\DoxyCodeLine{26   \{}
\DoxyCodeLine{27     \textcolor{keywordflow}{if}(!\mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}})}
\DoxyCodeLine{28     \{}
\DoxyCodeLine{29       \textcolor{keywordflow}{throw} \mbox{\hyperlink{structsys_1_1_exception}{Exception}}(\textcolor{stringliteral}{"{}Failed to allocate reference count"{}});}
\DoxyCodeLine{30     \}}
\DoxyCodeLine{31 }
\DoxyCodeLine{32     ++\mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}}-\/>strong;}
\DoxyCodeLine{33   \}}
\DoxyCodeLine{34 }
\DoxyCodeLine{35   \mbox{\hyperlink{structsys_1_1_enable_weak_a924d163bcfb5a1ea3af79e984bf9d197}{EnableWeak}}(\textcolor{keyword}{const} \mbox{\hyperlink{structsys_1_1_enable_weak}{EnableWeak}}\& \_copy) :}
\DoxyCodeLine{36     \mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}}(new \mbox{\hyperlink{structsys_1_1_rc}{Rc}}())}
\DoxyCodeLine{37   \{}
\DoxyCodeLine{38     \textcolor{keywordflow}{if}(!\mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}})}
\DoxyCodeLine{39     \{}
\DoxyCodeLine{40       \textcolor{keywordflow}{throw} \mbox{\hyperlink{structsys_1_1_exception}{Exception}}(\textcolor{stringliteral}{"{}Failed to allocate reference count"{}});}
\DoxyCodeLine{41     \}}
\DoxyCodeLine{42 }
\DoxyCodeLine{43     ++\mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}}-\/>strong;}
\DoxyCodeLine{44   \}}
\DoxyCodeLine{45 }
\DoxyCodeLine{46   \mbox{\hyperlink{structsys_1_1_enable_weak}{EnableWeak}}\& \mbox{\hyperlink{structsys_1_1_enable_weak_ad3e0f75752c9d305d3699786c08b1105}{operator=}}(\textcolor{keyword}{const} \mbox{\hyperlink{structsys_1_1_enable_weak}{EnableWeak}}\& \_other)}
\DoxyCodeLine{47   \{}
\DoxyCodeLine{48     \textcolor{keywordflow}{return} *\textcolor{keyword}{this};}
\DoxyCodeLine{49   \}}
\DoxyCodeLine{50 }
\DoxyCodeLine{51   \mbox{\hyperlink{structsys_1_1_enable_weak_ab9073442b29d465d9051f7e35f580ae6}{\string~EnableWeak}}()}
\DoxyCodeLine{52   \{}
\DoxyCodeLine{53     -\/-\/\mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}}-\/>strong;}
\DoxyCodeLine{54 }
\DoxyCodeLine{55     \textcolor{keywordflow}{if}(!\mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}}-\/>weak)}
\DoxyCodeLine{56     \{}
\DoxyCodeLine{57       \textcolor{keyword}{delete} \mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}};}
\DoxyCodeLine{58     \}}
\DoxyCodeLine{59   \}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61 \textcolor{keyword}{private}:}
\DoxyCodeLine{62   \textcolor{keyword}{template} <\textcolor{keyword}{typename} U>}
\DoxyCodeLine{63   \textcolor{keyword}{friend} \textcolor{keyword}{struct }\mbox{\hyperlink{structsys_1_1_weak}{Weak}};}
\DoxyCodeLine{64 }
\DoxyCodeLine{65   \mbox{\hyperlink{structsys_1_1_zero}{Zero<Rc*>}} \mbox{\hyperlink{structsys_1_1_enable_weak_a53ebd496e5e812c0d4da967c6e524efc}{m\_rc}};}
\DoxyCodeLine{66 \};}
\DoxyCodeLine{67 }
\DoxyCodeLine{68 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{69 \textcolor{keyword}{struct }\mbox{\hyperlink{structsys_1_1_weak}{Weak}}}
\DoxyCodeLine{70 \{}
\DoxyCodeLine{71   \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak}}();}
\DoxyCodeLine{72   \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak}}(\textcolor{keyword}{const} \mbox{\hyperlink{structsys_1_1_weak}{Weak}}\& \_copy);}
\DoxyCodeLine{73   \mbox{\hyperlink{structsys_1_1_weak}{Weak}}\& \mbox{\hyperlink{structsys_1_1_weak_ab6bcd292b981e47eb46d82f0be9ef113}{operator=}}(\textcolor{keyword}{const} \mbox{\hyperlink{structsys_1_1_weak}{Weak}}\& \_other);}
\DoxyCodeLine{74   \mbox{\hyperlink{structsys_1_1_weak_a1ecb8742234c3ead569e08edde4d5670}{\string~Weak}}();}
\DoxyCodeLine{75 }
\DoxyCodeLine{76   \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak}}(T* \_ptr);}
\DoxyCodeLine{77   \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak}}(\mbox{\hyperlink{structsys_1_1_ptr}{Ptr<T>}} \_ptr);}
\DoxyCodeLine{78 }
\DoxyCodeLine{79 \textcolor{preprocessor}{\#ifdef SYS\_DEBUG}}
\DoxyCodeLine{80   \mbox{\hyperlink{structsys_1_1_ptr_lock}{PtrLock<T>}} \mbox{\hyperlink{structsys_1_1_weak_a287c9d5554dd54d59bb53f7623d6c5f2}{operator-\/>}}() \textcolor{keyword}{const};}
\DoxyCodeLine{81 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{82   T* \mbox{\hyperlink{structsys_1_1_weak_a287c9d5554dd54d59bb53f7623d6c5f2}{operator-\/>}}() \textcolor{keyword}{const};}
\DoxyCodeLine{83 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{84 }
\DoxyCodeLine{85 \textcolor{keyword}{private}:}
\DoxyCodeLine{86   \textcolor{keyword}{template} <\textcolor{keyword}{typename} U>}
\DoxyCodeLine{87   \textcolor{keyword}{friend} \textcolor{keyword}{struct }\mbox{\hyperlink{structsys_1_1_ptr}{Ptr}};}
\DoxyCodeLine{88 }
\DoxyCodeLine{89   \mbox{\hyperlink{structsys_1_1_zero}{Zero<T*>}} \mbox{\hyperlink{structsys_1_1_weak_a3b702c4fd1d9ddf447395fa88a0b91f9}{m\_ptr}};}
\DoxyCodeLine{90   \mbox{\hyperlink{structsys_1_1_zero}{Zero<Rc*>}} \mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}};}
\DoxyCodeLine{91 \};}
\DoxyCodeLine{92 }
\DoxyCodeLine{93 \}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95 \textcolor{comment}{/* Implementation */}}
\DoxyCodeLine{96 }
\DoxyCodeLine{97 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_ptr_8h}{Ptr.h}}"{}}}
\DoxyCodeLine{98 }
\DoxyCodeLine{99 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacesys}{sys}}}
\DoxyCodeLine{100 \{}
\DoxyCodeLine{101 }
\DoxyCodeLine{102 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{103 \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak<T>::Weak}}()}
\DoxyCodeLine{104 \{ \}}
\DoxyCodeLine{105 }
\DoxyCodeLine{106 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{107 \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak<T>::Weak}}(\textcolor{keyword}{const} \mbox{\hyperlink{structsys_1_1_weak}{Weak}}\& \_copy) :}
\DoxyCodeLine{108   m\_ptr(\_copy.m\_ptr),}
\DoxyCodeLine{109   m\_rc(\_copy.m\_rc)}
\DoxyCodeLine{110 \{}
\DoxyCodeLine{111   \textcolor{keywordflow}{if}(\mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}})}
\DoxyCodeLine{112   \{}
\DoxyCodeLine{113     ++\mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}}-\/>weak;}
\DoxyCodeLine{114   \}}
\DoxyCodeLine{115 \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{118 \mbox{\hyperlink{structsys_1_1_weak}{Weak<T>}}\& \mbox{\hyperlink{structsys_1_1_weak_ab6bcd292b981e47eb46d82f0be9ef113}{Weak<T>::operator=}}(\textcolor{keyword}{const} \mbox{\hyperlink{structsys_1_1_weak}{Weak}}\& \_other)}
\DoxyCodeLine{119 \{}
\DoxyCodeLine{120   \mbox{\hyperlink{structsys_1_1_weak}{Weak}} tmp(*\textcolor{keyword}{this});}
\DoxyCodeLine{121 }
\DoxyCodeLine{122   \textcolor{keywordflow}{if}(m\_rc)}
\DoxyCodeLine{123   \{}
\DoxyCodeLine{124     -\/-\/m\_rc-\/>weak;}
\DoxyCodeLine{125   \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127   m\_ptr = \_other.\mbox{\hyperlink{structsys_1_1_weak_a3b702c4fd1d9ddf447395fa88a0b91f9}{m\_ptr}};}
\DoxyCodeLine{128   m\_rc = \_other.\mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}};}
\DoxyCodeLine{129 }
\DoxyCodeLine{130   \textcolor{keywordflow}{if}(m\_rc)}
\DoxyCodeLine{131   \{}
\DoxyCodeLine{132     ++m\_rc-\/>weak;}
\DoxyCodeLine{133   \}}
\DoxyCodeLine{134 }
\DoxyCodeLine{135   \textcolor{keywordflow}{return} *\textcolor{keyword}{this};}
\DoxyCodeLine{136 \}}
\DoxyCodeLine{137 }
\DoxyCodeLine{138 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{139 \mbox{\hyperlink{structsys_1_1_weak_a1ecb8742234c3ead569e08edde4d5670}{Weak<T>::\string~Weak}}()}
\DoxyCodeLine{140 \{}
\DoxyCodeLine{141   \textcolor{keywordflow}{if}(m\_rc)}
\DoxyCodeLine{142   \{}
\DoxyCodeLine{143     -\/-\/m\_rc-\/>weak;}
\DoxyCodeLine{144 }
\DoxyCodeLine{145     \textcolor{keywordflow}{if}(!m\_rc-\/>strong \&\& !m\_rc-\/>weak)}
\DoxyCodeLine{146     \{}
\DoxyCodeLine{147       \textcolor{keyword}{delete} m\_rc;}
\DoxyCodeLine{148     \}}
\DoxyCodeLine{149   \}}
\DoxyCodeLine{150 \}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{153 \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak<T>::Weak}}(T* \_ptr) :}
\DoxyCodeLine{154   m\_ptr(\_ptr)}
\DoxyCodeLine{155 \{}
\DoxyCodeLine{156   \textcolor{keywordflow}{if}(\mbox{\hyperlink{structsys_1_1_weak_a3b702c4fd1d9ddf447395fa88a0b91f9}{m\_ptr}})}
\DoxyCodeLine{157   \{}
\DoxyCodeLine{158     \mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}} = \mbox{\hyperlink{structsys_1_1_weak_a3b702c4fd1d9ddf447395fa88a0b91f9}{m\_ptr}}-\/>m\_rc;}
\DoxyCodeLine{159     ++\mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}}-\/>weak;}
\DoxyCodeLine{160   \}}
\DoxyCodeLine{161 \}}
\DoxyCodeLine{162 }
\DoxyCodeLine{163 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{164 \mbox{\hyperlink{structsys_1_1_weak_acf951f44224b3c0c1940536d0c4d75e7}{Weak<T>::Weak}}(\mbox{\hyperlink{structsys_1_1_ptr}{Ptr<T>}} \_ptr) :}
\DoxyCodeLine{165   m\_ptr(\_ptr.unsafe\_raw())}
\DoxyCodeLine{166 \{}
\DoxyCodeLine{167   \textcolor{keywordflow}{if}(\mbox{\hyperlink{structsys_1_1_weak_a3b702c4fd1d9ddf447395fa88a0b91f9}{m\_ptr}})}
\DoxyCodeLine{168   \{}
\DoxyCodeLine{169     \mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}} = \mbox{\hyperlink{structsys_1_1_weak_a3b702c4fd1d9ddf447395fa88a0b91f9}{m\_ptr}}-\/>m\_rc;}
\DoxyCodeLine{170     ++\mbox{\hyperlink{structsys_1_1_weak_afe35d172768f38a1b8a479e75941f366}{m\_rc}}-\/>weak;}
\DoxyCodeLine{171   \}}
\DoxyCodeLine{172 \}}
\DoxyCodeLine{173 }
\DoxyCodeLine{174 \textcolor{preprocessor}{\#ifdef SYS\_DEBUG}}
\DoxyCodeLine{175 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{176 \mbox{\hyperlink{structsys_1_1_ptr_lock}{PtrLock<T>}} \mbox{\hyperlink{structsys_1_1_weak_a287c9d5554dd54d59bb53f7623d6c5f2}{Weak<T>::operator-\/>}}()\textcolor{keyword}{ const}}
\DoxyCodeLine{177 \textcolor{keyword}{}\{}
\DoxyCodeLine{178   \textcolor{keywordflow}{if}(!m\_ptr || !m\_rc || !m\_rc-\/>strong)}
\DoxyCodeLine{179   \{}
\DoxyCodeLine{180     \mbox{\hyperlink{namespacesys_ab1ae7414319c425b1a5274f145874149}{sys::panic}}(\textcolor{stringliteral}{"{}Attempt to dereference NULL pointer"{}});}
\DoxyCodeLine{181   \}}
\DoxyCodeLine{182 }
\DoxyCodeLine{183   \textcolor{keywordflow}{return} \mbox{\hyperlink{structsys_1_1_ptr_lock}{PtrLock<T>}}(m\_ptr, m\_rc-\/>lock);}
\DoxyCodeLine{184 \}}
\DoxyCodeLine{185 }
\DoxyCodeLine{186 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{187 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{188 T* \mbox{\hyperlink{structsys_1_1_weak_a287c9d5554dd54d59bb53f7623d6c5f2}{Weak<T>::operator-\/>}}()\textcolor{keyword}{ const}}
\DoxyCodeLine{189 \textcolor{keyword}{}\{}
\DoxyCodeLine{190   \textcolor{keywordflow}{if}(!m\_ptr || !m\_rc || !m\_rc-\/>strong)}
\DoxyCodeLine{191   \{}
\DoxyCodeLine{192     \mbox{\hyperlink{namespacesys_ab1ae7414319c425b1a5274f145874149}{sys::panic}}(\textcolor{stringliteral}{"{}Attempt to dereference NULL pointer"{}});}
\DoxyCodeLine{193   \}}
\DoxyCodeLine{194 }
\DoxyCodeLine{195   \textcolor{keywordflow}{return} m\_ptr;}
\DoxyCodeLine{196 \}}
\DoxyCodeLine{197 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{198 }
\DoxyCodeLine{199 \}}
\DoxyCodeLine{200 }

\end{DoxyCode}
